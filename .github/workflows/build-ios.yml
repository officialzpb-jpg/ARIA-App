name: Build ARIA iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Create Swift Package Project
      run: |
        mkdir -p ios
        cd ios
        
        # Create Package.swift
        cat > Package.swift << 'EOF'
        // swift-tools-version:5.9
        import PackageDescription

        let package = Package(
            name: "ARIA",
            platforms: [.iOS(.v16)],
            products: [
                .executable(name: "ARIA", targets: ["ARIA"])
            ],
            targets: [
                .executableTarget(
                    name: "ARIA",
                    path: "Sources",
                    swiftSettings: [.define("DEBUG", .when(configuration: .debug))]
                )
            ]
        )
        EOF
        
        # Create Sources directory with main.swift
        mkdir -p Sources
        cat > Sources/main.swift << 'EOF'
        import SwiftUI

        @main
        struct ARIAApp: App {
            var body: some Scene {
                WindowGroup {
                    ContentView()
                }
            }
        }

        struct ContentView: View {
            var body: some View {
                VStack {
                    Text("ARIA")
                        .font(.largeTitle)
                    Text("Hello World")
                }
            }
        }
        EOF
    
    - name: Build with Swift Package Manager
      run: |
        cd ios
        swift build -Xswiftc -sdk -Xswiftc $(xcrun --sdk iphoneos --show-sdk-path) -Xswiftc -target -Xswiftc arm64-apple-ios16.0
    
    - name: Create IPA from build
      run: |
        cd ios
        # Find the built binary
        find .build -name "ARIA" -type f 2>/dev/null | head -1
        
        # Create app bundle structure
        mkdir -p Payload/ARIA.app
        
        # Copy binary
        cp $(find .build -name "ARIA" -type f | head -1) Payload/ARIA.app/ARIA 2>/dev/null || echo "Binary not found"
        
        # Create minimal Info.plist
        cat > Payload/ARIA.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>ARIA</string>
            <key>CFBundleIdentifier</key>
            <string>com.officialzpb.aria</string>
            <key>CFBundleName</key>
            <string>ARIA</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
        </dict>
        </plist>
        EOF
        
        # Create IPA
        zip -r ../ARIA.ipa Payload
        ls -lh ../ARIA.ipa
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ARIA-iOS
        path: ARIA.ipa
