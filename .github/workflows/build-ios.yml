name: Build ARIA iOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Clone Working iOS Template
      run: |
        # Clone a minimal working iOS project
        git clone --depth 1 https://github.com/cocoacasts/building-a-swiftui-app-using-the-mvvm-design-pattern.git template
        
        # Rename to ARIA
        mv template MVVM-ARIA
        cd MVVM-ARIA
        
        # Remove git history
        rm -rf .git
        
        # Rename project references
        find . -name "*.swift" -exec sed -i '' 's/MVVM/ARIA/g' {} \; 2>/dev/null || true
        find . -name "*.xcodeproj" -exec sed -i '' 's/MVVM/ARIA/g' {} \; 2>/dev/null || true
        
        # Move to ios directory
        cd ..
        mkdir -p ios
        mv MVVM-ARIA/* ios/ 2>/dev/null || true
        
        ls -la ios/
    
    - name: Build Archive
      run: |
        cd ios
        
        # Find the xcodeproj
        PROJECT=$(find . -name "*.xcodeproj" -type d | head -1)
        echo "Found project: $PROJECT"
        
        # List schemes
        xcodebuild -list -project "$PROJECT" 2>&1 || true
        
        # Build
        xcodebuild -project "$PROJECT" \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath build/ARIA.xcarchive \
          archive \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee build.log || true
        
        # Check if build succeeded
        if [ ! -d "build/ARIA.xcarchive" ]; then
          echo "Trying alternative build..."
          # Try with scheme
          SCHEME=$(xcodebuild -list -project "$PROJECT" 2>&1 | grep -A 1 "Schemes:" | tail -1 | xargs)
          echo "Using scheme: $SCHEME"
          
          xcodebuild -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/ARIA.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO
        fi
    
    - name: Create IPA
      run: |
        cd ios
        ls -la build/
        
        APP_PATH=$(find build -name "*.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r ../ARIA.ipa Payload
          ls -lh ../ARIA.ipa
        else
          echo "No .app found"
          find build -type f
          exit 1
        fi
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ARIA-iOS
        path: ARIA.ipa
