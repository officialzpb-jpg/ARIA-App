name: Build ARIA iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Create iOS Project Structure
      run: |
        # Create project directory
        mkdir -p ARIA-iOS/ARIA
        cd ARIA-iOS
        
        # Copy Swift source files
        cp ../ARIA_iOS.swift ARIA/
        cp ../ARIA_iOS_SystemIntegration.swift ARIA/
        
        # Create a minimal App.swift if needed
        cat > ARIA/App.swift << 'EOF'
        import SwiftUI

        @main
        struct ARIAApp: App {
            var body: some Scene {
                WindowGroup {
                    ContentView()
                }
            }
        }

        struct ContentView: View {
            var body: some View {
                VStack {
                    Image(systemName: "globe")
                        .imageScale(.large)
                        .foregroundStyle(.tint)
                    Text("ARIA")
                        .font(.largeTitle)
                    Text("AI Routing & Integration Assistant")
                        .font(.subheadline)
                }
                .padding()
            }
        }
        EOF
        
    - name: Build with Swift Package Manager
      run: |
        cd ARIA-iOS
        
        # Create a simple Package.swift for SPM build
        cat > Package.swift << 'EOF'
        // swift-tools-version:5.9
        import PackageDescription

        let package = Package(
            name: "ARIA",
            platforms: [.iOS(.v16)],
            products: [
                .executable(name: "ARIA", targets: ["ARIA"])
            ],
            targets: [
                .executableTarget(
                    name: "ARIA",
                    path: "ARIA",
                    swiftSettings: [
                        .define("DEBUG", .when(configuration: .debug))
                    ]
                )
            ]
        )
        EOF
        
        # Try building with swift build (won't work for iOS directly, but let's try xcodebuild)
        echo "Building iOS app..."
        
    - name: Build iOS App with xcodebuild
      run: |
        cd ARIA-iOS
        
        # Create a minimal Xcode project using xcodebuild
        # First, let's create the project structure manually
        mkdir -p ARIA.xcodeproj
        
        # Create project.pbxproj
        cat > ARIA.xcodeproj/project.pbxproj << 'PROJEOF'
        // !$*UTF8*$!
        {
            archiveVersion = 1;
            classes = {
            };
            objectVersion = 56;
            objects = {
                ARIA00000000000000000001 = {isa = PBXBuildFile; fileRef = ARIA00000000000000000011; };
                ARIA00000000000000000010 = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = ARIA.app; sourceTree = BUILT_PRODUCTS_DIR; };
                ARIA00000000000000000011 = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = App.swift; sourceTree = "<group>"; };
                ARIA00000000000000000030 = {isa = PBXGroup; children = (ARIA00000000000000000031,ARIA00000000000000000032); sourceTree = "<group>"; };
                ARIA00000000000000000031 = {isa = PBXGroup; children = (ARIA00000000000000000011); path = ARIA; sourceTree = "<group>"; };
                ARIA00000000000000000032 = {isa = PBXGroup; children = (ARIA00000000000000000010); name = Products; sourceTree = "<group>"; };
                ARIA00000000000000000040 = {isa = PBXNativeTarget; buildConfigurationList = ARIA00000000000000000041; buildPhases = (ARIA00000000000000000042,ARIA00000000000000000043); buildRules = (); dependencies = (); name = ARIA; productName = ARIA; productReference = ARIA00000000000000000010; productType = "com.apple.product-type.application"; };
                ARIA00000000000000000042 = {isa = PBXSourcesBuildPhase; buildActionMask = 2147483647; files = (ARIA00000000000000000001); runOnlyForDeploymentPostprocessing = 0; };
                ARIA00000000000000000043 = {isa = PBXResourcesBuildPhase; buildActionMask = 2147483647; files = (); runOnlyForDeploymentPostprocessing = 0; };
                ARIA00000000000000000050 = {isa = PBXProject; buildConfigurationList = ARIA00000000000000000051; compatibilityVersion = "Xcode 14.0"; developmentRegion = en; hasScannedForEncodings = 0; knownRegions = (en,Base); mainGroup = ARIA00000000000000000030; productRefGroup = ARIA00000000000000000032; projectDirPath = ""; projectRoot = ""; targets = (ARIA00000000000000000040); };
                ARIA00000000000000000051 = {isa = XCConfigurationList; buildConfigurations = (ARIA00000000000000000060,ARIA00000000000000000061); defaultConfigurationIsVisible = 0; defaultConfigurationName = Release; };
                ARIA00000000000000000041 = {isa = XCConfigurationList; buildConfigurations = (ARIA00000000000000000070,ARIA00000000000000000071); defaultConfigurationIsVisible = 0; defaultConfigurationName = Release; };
                ARIA00000000000000000060 = {isa = XCBuildConfiguration; buildSettings = {ALWAYS_SEARCH_USER_PATHS = NO; ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS = YES; CLANG_ANALYZER_NONNULL = YES; CLANG_CXX_LANGUAGE_STANDARD = "gnu++20"; CLANG_ENABLE_MODULES = YES; CLANG_ENABLE_OBJC_ARC = YES; DEBUG_INFORMATION_FORMAT = dwarf; ENABLE_STRICT_OBJC_MSGSEND = YES; ENABLE_TESTABILITY = YES; GCC_C_LANGUAGE_STANDARD = gnu17; GCC_DYNAMIC_NO_PIC = NO; GCC_NO_COMMON_BLOCKS = YES; GCC_OPTIMIZATION_LEVEL = 0; GCC_PREPROCESSOR_DEFINITIONS = ("DEBUG=1",); IPHONEOS_DEPLOYMENT_TARGET = 16.0; MTL_ENABLE_DEBUG_INFO = INCLUDE_SOURCE; MTL_FAST_MATH = YES; ONLY_ACTIVE_ARCH = YES; SDKROOT = iphoneos; SWIFT_ACTIVE_COMPILATION_CONDITIONS = "DEBUG"; SWIFT_OPTIMIZATION_LEVEL = "-Onone"; }; name = Debug; };
                ARIA00000000000000000061 = {isa = XCBuildConfiguration; buildSettings = {ALWAYS_SEARCH_USER_PATHS = NO; ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS = YES; CLANG_ANALYZER_NONNULL = YES; CLANG_CXX_LANGUAGE_STANDARD = "gnu++20"; CLANG_ENABLE_MODULES = YES; CLANG_ENABLE_OBJC_ARC = YES; DEBUG_INFORMATION_FORMAT = "dwarf-with-dsym"; ENABLE_NS_ASSERTIONS = NO; ENABLE_STRICT_OBJC_MSGSEND = YES; GCC_C_LANGUAGE_STANDARD = gnu17; GCC_NO_COMMON_BLOCKS = YES; IPHONEOS_DEPLOYMENT_TARGET = 16.0; MTL_ENABLE_DEBUG_INFO = NO; MTL_FAST_MATH = YES; SDKROOT = iphoneos; SWIFT_COMPILATION_MODE = wholemodule; VALIDATE_PRODUCT = YES; }; name = Release; };
                ARIA00000000000000000070 = {isa = XCBuildConfiguration; buildSettings = {ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon; CODE_SIGN_STYLE = Automatic; CURRENT_PROJECT_VERSION = 1; GENERATE_INFOPLIST_FILE = YES; INFOPLIST_KEY_UILaunchScreen_Generation = YES; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; LD_RUNPATH_SEARCH_PATHS = ("$(inherited)","@executable_path/Frameworks"); MARKETING_VERSION = 1.0; PRODUCT_BUNDLE_IDENTIFIER = com.officialzpb.aria; PRODUCT_NAME = "$(TARGET_NAME)"; SWIFT_EMIT_LOC_STRINGS = YES; SWIFT_VERSION = 5.0; TARGETED_DEVICE_FAMILY = "1,2"; }; name = Debug; };
                ARIA00000000000000000071 = {isa = XCBuildConfiguration; buildSettings = {ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon; CODE_SIGN_STYLE = Automatic; CURRENT_PROJECT_VERSION = 1; GENERATE_INFOPLIST_FILE = YES; INFOPLIST_KEY_UILaunchScreen_Generation = YES; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight"; LD_RUNPATH_SEARCH_PATHS = ("$(inherited)","@executable_path/Frameworks"); MARKETING_VERSION = 1.0; PRODUCT_BUNDLE_IDENTIFIER = com.officialzpb.aria; PRODUCT_NAME = "$(TARGET_NAME)"; SWIFT_EMIT_LOC_STRINGS = YES; SWIFT_VERSION = 5.0; TARGETED_DEVICE_FAMILY = "1,2"; }; name = Release; };
            };
            rootObject = ARIA00000000000000000050;
        }
        PROJEOF
        
        # Build the archive
        xcodebuild -project ARIA.xcodeproj \
          -scheme ARIA \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath $PWD/build/ARIA.xcarchive \
          archive \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          || echo "Build may have warnings but continuing..."
          
    - name: Create IPA
      run: |
        cd ARIA-iOS
        
        # Check if archive was created
        if [ -d "build/ARIA.xcarchive/Products/Applications/ARIA.app" ]; then
          # Create Payload directory
          mkdir -p Payload
          cp -r build/ARIA.xcarchive/Products/Applications/ARIA.app Payload/
          
          # Create IPA
          zip -r ARIA.ipa Payload
          echo "IPA created successfully"
        else
          echo "Archive not found, checking build directory..."
          ls -la build/ 2>/dev/null || echo "No build directory"
          exit 1
        fi
        
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ARIA-iOS-IPA
        path: ARIA-iOS/ARIA.ipa
        retention-days: 30
        
    - name: Upload Build Logs on Failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: ARIA-iOS/build/
        retention-days: 7
