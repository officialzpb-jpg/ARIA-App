name: Build ARIA iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Show Xcode version
      run: |
        xcodebuild -version
        xcodebuild -showsdks
        
    - name: Create ARIA iOS Project
      run: |
        mkdir -p ARIA-iOS/ARIA/Assets.xcassets/AppIcon.appiconset
        cd ARIA-iOS
        
        # Create a minimal App.swift - very simple, no complex syntax
        cat > ARIA/App.swift << 'EOF'
        import SwiftUI

        @main
        struct ARIAApp: App {
            var body: some Scene {
                WindowGroup {
                    ContentView()
                }
            }
        }

        struct ContentView: View {
            @State private var isRecording = false
            @State private var transcript = ""
            @State private var response = ""

            var body: some View {
                NavigationView {
                    VStack {
                        Text("ARIA")
                            .font(.largeTitle)
                            .padding()
                        
                        Text("AI Routing & Integration Assistant")
                            .font(.subheadline)
                            .foregroundColor(.secondary)
                        
                        Spacer()
                        
                        Button(action: {
                            isRecording.toggle()
                            if !isRecording {
                                transcript = "Hello ARIA"
                                response = "Hi! I'm ARIA. Connect me to your backend for full functionality."
                            }
                        }) {
                            Image(systemName: isRecording ? "stop.circle.fill" : "mic.circle.fill")
                                .font(.system(size: 80))
                                .foregroundColor(isRecording ? .red : .blue)
                        }
                        
                        Text(isRecording ? "Recording..." : "Tap to speak")
                            .padding()
                        
                        Spacer()
                        
                        if !transcript.isEmpty {
                            Text("You: " + transcript)
                                .padding()
                        }
                        
                        if !response.isEmpty {
                            Text("ARIA: " + response)
                                .padding()
                                .background(Color.blue.opacity(0.1))
                                .cornerRadius(10)
                        }
                        
                        Spacer()
                    }
                }
            }
        }
        EOF
        
        # Create Assets
        echo '{"images":[{"idiom":"universal","platform":"ios","size":"1024x1024"}],"info":{"author":"xcode","version":1}}' > ARIA/Assets.xcassets/AppIcon.appiconset/Contents.json
        
    - name: Create and Build Xcode Project
      run: |
        cd ARIA-iOS
        
        # Create a minimal Xcode project using xcodebuild
        # First, create the project file structure
        mkdir -p ARIA.xcodeproj
        
        # Generate a minimal project.pbxproj using xcodebuild's ability to create projects
        # We'll use swift package manager approach instead
        
        # Create Package.swift for SPM
        cat > Package.swift << 'EOF'
        // swift-tools-version:5.9
        import PackageDescription

        let package = Package(
            name: "ARIA",
            platforms: [.iOS(.v16)],
            products: [
                .library(name: "ARIA", targets: ["ARIA"])
            ],
            targets: [
                .target(
                    name: "ARIA",
                    path: "ARIA",
                    exclude: [],
                    resources: [
                        .process("Assets.xcassets")
                    ]
                )
            ]
        )
        EOF
        
        # Actually, let's use a different approach - create a proper Xcode project
        # Using xcodebuild to create a new project
        
        cd ..
        rm -rf ARIA-iOS
        mkdir ARIA-iOS
        cd ARIA-iOS
        
        # Create the Swift file
        mkdir ARIA
        cat > ARIA/main.swift << 'EOF'
        import UIKit
        import SwiftUI

        @main
        struct ARIAApp: App {
            var body: some Scene {
                WindowGroup {
                    ContentView()
                }
            }
        }

        struct ContentView: View {
            @State private var isRecording = false
            
            var body: some View {
                VStack {
                    Text("ARIA")
                        .font(.largeTitle)
                        .padding()
                    
                    Button(action: { isRecording.toggle() }) {
                        Image(systemName: isRecording ? "stop.fill" : "mic.fill")
                            .font(.largeTitle)
                            .padding()
                    }
                    
                    Text(isRecording ? "Recording..." : "Tap to speak")
                }
            }
        }
        EOF
        
        # Create Info.plist
        cat > ARIA/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>$(DEVELOPMENT_LANGUAGE)</string>
            <key>CFBundleExecutable</key>
            <string>$(EXECUTABLE_NAME)</string>
            <key>CFBundleIdentifier</key>
            <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>$(PRODUCT_NAME)</string>
            <key>CFBundlePackageType</key>
            <string>$(PRODUCT_BUNDLE_PACKAGE_TYPE)</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UIApplicationSceneManifest</key>
            <dict>
                <key>UIApplicationSupportsMultipleScenes</key>
                <true/>
            </dict>
            <key>UIApplicationSupportsIndirectInputEvents</key>
            <true/>
            <key>UILaunchScreen</key>
            <dict/>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
            </array>
        </dict>
        </plist>
        EOF
        
        # Create project using xcodebuild
        xcodebuild -createProject -project ARIA.xcodeproj
        
    - name: Build with xcodebuild directly
      run: |
        cd ARIA-iOS
        
        # Try building the Swift file directly as a simple app
        # Use xcrun to compile for iOS
        
        # Create a minimal app bundle structure
        mkdir -p build/ARIA.app
        
        # Compile the Swift file
        xcrun -sdk iphoneos swiftc \
          -target arm64-apple-ios16.0 \
          -o build/ARIA.app/ARIA \
          ARIA/main.swift \
          -framework UIKit \
          -framework SwiftUI \
          2>&1 || echo "Direct compile failed, trying alternative..."
        
        # If that fails, let's try using xcodebuild with a generated project
        # Create a minimal project structure that xcodebuild can work with
        
    - name: Alternative Build - Use ios-template
      run: |
        # Clone a minimal iOS template and modify it
        git clone --depth 1 https://github.com/ios-templates/swiftui-minimal-template.git template 2>/dev/null || true
        
        if [ -d "template" ]; then
          cd template
          # Replace the content with our app
          rm -rf swiftui-minimal-template
          mkdir swiftui-minimal-template
          cp ../ARIA-iOS/ARIA/main.swift swiftui-minimal-template/
          
          # Build
          xcodebuild -project swiftui-minimal-template.xcodeproj \
            -scheme swiftui-minimal-template \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "$PWD/build/ARIA.xcarchive" \
            archive \
            CODE_SIGNING_ALLOWED=NO
        fi
        
    - name: Create IPA from build
      run: |
        if [ -d "template/build/ARIA.xcarchive/Products/Applications/ARIA.app" ]; then
          cd template
          mkdir -p Payload
          cp -r build/ARIA.xcarchive/Products/Applications/ARIA.app Payload/
          zip -r ../ARIA.ipa Payload
          cd ..
          ls -lh ARIA.ipa
        elif [ -d "ARIA-iOS/build/ARIA.app" ]; then
          cd ARIA-iOS
          mkdir -p Payload
          cp -r build/ARIA.app Payload/
          zip -r ../ARIA.ipa Payload
          cd ..
          ls -lh ARIA.ipa
        else
          echo "Build failed - checking what we have:"
          find . -name "*.app" -o -name "*.xcarchive" 2>/dev/null || true
          exit 1
        fi
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ARIA-iOS-IPA
        path: ARIA.ipa
        retention-days: 30
