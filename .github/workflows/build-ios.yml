name: Build ARIA iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Create ARIA iOS Project
      run: |
        mkdir -p ARIA-iOS/ARIA
        cd ARIA-iOS
        
        # Create a simple, working App.swift
        cat > ARIA/App.swift << 'EOF'
        import SwiftUI
        import AVFoundation
        import Speech

        @main
        struct ARIAApp: App {
            var body: some Scene {
                WindowGroup {
                    ContentView()
                }
            }
        }

        struct ContentView: View {
            @State private var isRecording = false
            @State private var transcript = ""
            @State private var response = ""
            @State private var selectedPersona = 0
            
            let personas = ["Default", "Executive", "Creative", "Technical", "Concise"]
            
            var body: some View {
                NavigationView {
                    VStack(spacing: 25) {
                        // Header
                        VStack(spacing: 10) {
                            Image(systemName: "waveform.circle.fill")
                                .font(.system(size: 70))
                                .foregroundColor(.blue)
                            
                            Text("ARIA")
                                .font(.system(size: 36, weight: .bold))
                            
                            Text("AI Routing & Integration Assistant")
                                .font(.subheadline)
                                .foregroundColor(.secondary)
                                .multilineTextAlignment(.center)
                        }
                        .padding(.top, 30)
                        
                        Spacer()
                        
                        // Recording Button
                        Button(action: toggleRecording) {
                            ZStack {
                                Circle()
                                    .fill(isRecording ? Color.red : Color.blue)
                                    .frame(width: 90, height: 90)
                                    .shadow(radius: 10)
                                
                                Image(systemName: isRecording ? "stop.fill" : "mic.fill")
                                    .font(.system(size: 35))
                                    .foregroundColor(.white)
                            }
                        }
                        
                        Text(isRecording ? "Listening..." : "Tap to speak")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // Persona Selector
                        VStack(alignment: .leading) {
                            Text("Persona")
                                .font(.caption)
                                .foregroundColor(.secondary)
                                .padding(.horizontal)
                            
                            ScrollView(.horizontal, showsIndicators: false) {
                                HStack(spacing: 10) {
                                    ForEach(0..<personas.count, id: \.self) { index in
                                        Button(action: { selectedPersona = index }) {
                                            Text(personas[index])
                                                .font(.subheadline)
                                                .padding(.horizontal, 15)
                                                .padding(.vertical, 8)
                                                .background(selectedPersona == index ? Color.blue : Color.gray.opacity(0.2))
                                                .foregroundColor(selectedPersona == index ? .white : .primary)
                                                .cornerRadius(20)
                                        }
                                    }
                                }
                                .padding(.horizontal)
                            }
                        }
                        
                        Spacer()
                        
                        // Display Area
                        ScrollView {
                            VStack(spacing: 15) {
                                if !transcript.isEmpty {
                                    VStack(alignment: .leading, spacing: 5) {
                                        Text("You said:")
                                            .font(.caption)
                                            .foregroundColor(.secondary)
                                        Text(transcript)
                                            .font(.body)
                                            .padding()
                                            .frame(maxWidth: .infinity, alignment: .leading)
                                            .background(Color.gray.opacity(0.15))
                                            .cornerRadius(12)
                                    }
                                }
                                
                                if !response.isEmpty {
                                    VStack(alignment: .leading, spacing: 5) {
                                        Text("ARIA:")
                                            .font(.caption)
                                            .foregroundColor(.blue)
                                        Text(response)
                                            .font(.body)
                                            .padding()
                                            .frame(maxWidth: .infinity, alignment: .leading)
                                            .background(Color.blue.opacity(0.1))
                                            .cornerRadius(12)
                                    }
                                }
                            }
                            .padding(.horizontal)
                        }
                        
                        Spacer()
                        
                        // Settings Link
                        NavigationLink(destination: SettingsView()) {
                            HStack {
                                Image(systemName: "gear")
                                Text("Settings")
                            }
                            .font(.subheadline)
                            .padding(.horizontal, 20)
                            .padding(.vertical, 10)
                            .background(Color.gray.opacity(0.15))
                            .cornerRadius(8)
                        }
                        .padding(.bottom, 20)
                    }
                    .navigationBarHidden(true)
                }
            }
            
            func toggleRecording() {
                isRecording.toggle()
                
                if isRecording {
                    // Request permissions and start
                    requestPermissions()
                    transcript = ""
                    response = ""
                } else {
                    // Stop and simulate response
                    transcript = "Hello ARIA, what can you do?"
                    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
                        response = "I'm ARIA, your AI Routing & Integration Assistant. I can process voice commands, connect to AI models, and route responses to various platforms like Telegram, Discord, and more. Connect me to your backend for full functionality!"
                    }
                }
            }
            
            func requestPermissions() {
                AVAudioSession.sharedInstance().requestRecordPermission { _ in }
                SFSpeechRecognizer.requestAuthorization { _ in }
            }
        }

        struct SettingsView: View {
            @State private var backendURL = ""
            @State private var apiKey = ""
            
            var body: some View {
                Form {
                    Section(header: Text("Backend Connection")) {
                        TextField("Backend URL", text: $backendURL)
                            .autocapitalization(.none)
                            .keyboardType(.URL)
                        
                        SecureField("API Key", text: $apiKey)
                        
                        Button("Save") {
                            UserDefaults.standard.set(backendURL, forKey: "backendURL")
                            UserDefaults.standard.set(apiKey, forKey: "apiKey")
                        }
                    }
                    
                    Section(header: Text("About")) {
                        HStack {
                            Text("Version")
                            Spacer()
                            Text("1.0.0")
                                .foregroundColor(.secondary)
                        }
                        HStack {
                            Text("Build")
                            Spacer()
                            Text("GitHub Actions")
                                .foregroundColor(.secondary)
                        }
                    }
                }
                .navigationTitle("Settings")
                .onAppear {
                    backendURL = UserDefaults.standard.string(forKey: "backendURL") ?? ""
                    apiKey = UserDefaults.standard.string(forKey: "apiKey") ?? ""
                }
            }
        }
        EOF
        
        # Create Assets
        mkdir -p ARIA/Assets.xcassets/AppIcon.appiconset
        cat > ARIA/Assets.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
        {"images":[{"idiom":"universal","platform":"ios","size":"1024x1024"}],"info":{"author":"xcode","version":1}}
        EOF
        
    - name: Create Xcode Project
      run: |
        cd ARIA-iOS
        mkdir -p ARIA.xcodeproj
        
        # Create a minimal but valid project.pbxproj
        cat > ARIA.xcodeproj/project.pbxproj <> 'PROJEOF'
        // !$*UTF8*$!
        {
        	archiveVersion = 1;
        	classes = {
        	};
        	objectVersion = 56;
        	objects = {
        
        /* Begin PBXBuildFile section */
        		A1B2C3D4E5F6789012345678 /* App.swift in Sources */ = {isa = PBXBuildFile; fileRef = A1B2C3D4E5F6789012345670 /* App.swift */; };
        		A1B2C3D4E5F6789012345679 /* Assets.xcassets in Resources */ = {isa = PBXBuildFile; fileRef = A1B2C3D4E5F6789012345671 /* Assets.xcassets */; };
        /* End PBXBuildFile section */

        /* Begin PBXFileReference section */
        		A1B2C3D4E5F6789012345660 /* ARIA.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = ARIA.app; sourceTree = BUILT_PRODUCTS_DIR; };
        		A1B2C3D4E5F6789012345670 /* App.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = App.swift; sourceTree = "<group>"; };
        		A1B2C3D4E5F6789012345671 /* Assets.xcassets */ = {isa = PBXFileReference; lastKnownFileType = folder.assetcatalog; path = Assets.xcassets; sourceTree = "<group>"; };
        /* End PBXFileReference section */

        /* Begin PBXFrameworksBuildPhase section */
        		A1B2C3D4E5F6789012345655 /* Frameworks */ = {
        			isa = PBXFrameworksBuildPhase;
        			buildActionMask = 2147483647;
        			files = (
        			);
        			runOnlyForDeploymentPostprocessing = 0;
        		};
        /* End PBXFrameworksBuildPhase section */

        /* Begin PBXGroup section */
        		A1B2C3D4E5F6789012345650 = {
        			isa = PBXGroup;
        			children = (
        				A1B2C3D4E5F6789012345665 /* ARIA */,
        				A1B2C3D4E5F6789012345661 /* Products */,
        			);
        			sourceTree = "<group>";
        		};
        		A1B2C3D4E5F6789012345661 /* Products */ = {
        			isa = PBXGroup;
        			children = (
        				A1B2C3D4E5F6789012345660 /* ARIA.app */,
        			);
        			name = Products;
        			sourceTree = "<group>";
        		};
        		A1B2C3D4E5F6789012345665 /* ARIA */ = {
        			isa = PBXGroup;
        			children = (
        				A1B2C3D4E5F6789012345670 /* App.swift */,
        				A1B2C3D4E5F6789012345671 /* Assets.xcassets */,
        			);
        			path = ARIA;
        			sourceTree = "<group>";
        		};
        /* End PBXGroup section */

        /* Begin PBXNativeTarget section */
        		A1B2C3D4E5F678901234565F /* ARIA */ = {
        			isa = PBXNativeTarget;
        			buildConfigurationList = A1B2C3D4E5F6789012345680 /* Build configuration list for PBXNativeTarget "ARIA" */;
        			buildPhases = (
        				A1B2C3D4E5F6789012345654 /* Sources */,
        				A1B2C3D4E5F6789012345655 /* Frameworks */,
        				A1B2C3D4E5F6789012345656 /* Resources */,
        			);
        			buildRules = (
        			);
        			dependencies = (
        			);
        			name = ARIA;
        			productName = ARIA;
        			productReference = A1B2C3D4E5F6789012345660 /* ARIA.app */;
        			productType = "com.apple.product-type.application";
        		};
        /* End PBXNativeTarget section */

        /* Begin PBXProject section */
        		A1B2C3D4E5F6789012345651 /* Project object */ = {
        			isa = PBXProject;
        			buildConfigurationList = A1B2C3D4E5F6789012345652 /* Build configuration list for PBXProject "ARIA" */;
        			compatibilityVersion = "Xcode 14.0";
        			developmentRegion = en;
        			hasScannedForEncodings = 0;
        			knownRegions = (
        				en,
        				Base,
        			);
        			mainGroup = A1B2C3D4E5F6789012345650;
        			productRefGroup = A1B2C3D4E5F6789012345661 /* Products */;
        			projectDirPath = "";
        			projectRoot = "";
        			targets = (
        				A1B2C3D4E5F678901234565F /* ARIA */,
        			);
        		};
        /* End PBXProject section */

        /* Begin PBXResourcesBuildPhase section */
        		A1B2C3D4E5F6789012345656 /* Resources */ = {
        			isa = PBXResourcesBuildPhase;
        			buildActionMask = 2147483647;
        			files = (
        				A1B2C3D4E5F6789012345679 /* Assets.xcassets in Resources */,
        			);
        			runOnlyForDeploymentPostprocessing = 0;
        		};
        /* End PBXResourcesBuildPhase section */

        /* Begin PBXSourcesBuildPhase section */
        		A1B2C3D4E5F6789012345654 /* Sources */ = {
        			isa = PBXSourcesBuildPhase;
        			buildActionMask = 2147483647;
        			files = (
        				A1B2C3D4E5F6789012345678 /* App.swift in Sources */,
        			);
        			runOnlyForDeploymentPostprocessing = 0;
        		};
        /* End PBXSourcesBuildPhase section */

        /* Begin XCBuildConfiguration section */
        		A1B2C3D4E5F6789012345672 /* Debug */ = {
        			isa = XCBuildConfiguration;
        			buildSettings = {
        				ALWAYS_SEARCH_USER_PATHS = NO;
        				ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS = YES;
        				CLANG_ANALYZER_NONNULL = YES;
        				CLANG_CXX_LANGUAGE_STANDARD = "gnu++20";
        				CLANG_ENABLE_MODULES = YES;
        				CLANG_ENABLE_OBJC_ARC = YES;
        				DEBUG_INFORMATION_FORMAT = dwarf;
        				ENABLE_STRICT_OBJC_MSGSEND = YES;
        				ENABLE_TESTABILITY = YES;
        				GCC_C_LANGUAGE_STANDARD = gnu17;
        				GCC_DYNAMIC_NO_PIC = NO;
        				GCC_NO_COMMON_BLOCKS = YES;
        				GCC_OPTIMIZATION_LEVEL = 0;
        				GCC_PREPROCESSOR_DEFINITIONS = (
        					"DEBUG=1",
        				);
        				IPHONEOS_DEPLOYMENT_TARGET = 16.0;
        				MTL_ENABLE_DEBUG_INFO = INCLUDE_SOURCE;
        				MTL_FAST_MATH = YES;
        				ONLY_ACTIVE_ARCH = YES;
        				SDKROOT = iphoneos;
        				SWIFT_ACTIVE_COMPILATION_CONDITIONS = "DEBUG";
        				SWIFT_OPTIMIZATION_LEVEL = "-Onone";
        			};
        			name = Debug;
        	};
        		A1B2C3D4E5F6789012345673 /* Release */ = {
        			isa = XCBuildConfiguration;
        			buildSettings = {
        				ALWAYS_SEARCH_USER_PATHS = NO;
        				ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS = YES;
        				CLANG_ANALYZER_NONNULL = YES;
        				CLANG_CXX_LANGUAGE_STANDARD = "gnu++20";
        				CLANG_ENABLE_MODULES = YES;
        				CLANG_ENABLE_OBJC_ARC = YES;
        				DEBUG_INFORMATION_FORMAT = "dwarf-with-dsym";
        				ENABLE_NS_ASSERTIONS = NO;
        				ENABLE_STRICT_OBJC_MSGSEND = YES;
        				GCC_C_LANGUAGE_STANDARD = gnu17;
        				GCC_NO_COMMON_BLOCKS = YES;
        				IPHONEOS_DEPLOYMENT_TARGET = 16.0;
        				MTL_ENABLE_DEBUG_INFO = NO;
        				MTL_FAST_MATH = YES;
        				SDKROOT = iphoneos;
        				SWIFT_COMPILATION_MODE = wholemodule;
        				VALIDATE_PRODUCT = YES;
        			};
        			name = Release;
        	};
        		A1B2C3D4E5F6789012345681 /* Debug */ = {
        			isa = XCBuildConfiguration;
        			buildSettings = {
        				ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
        				CODE_SIGN_STYLE = Automatic;
        				CURRENT_PROJECT_VERSION = 1;
        				GENERATE_INFOPLIST_FILE = YES;
        				INFOPLIST_KEY_NSMicrophoneUsageDescription = "ARIA needs microphone access for voice commands";
        				INFOPLIST_KEY_NSSpeechRecognitionUsageDescription = "ARIA needs speech recognition to process your voice";
        				INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES;
        				INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES;
        				INFOPLIST_KEY_UILaunchScreen_Generation = YES;
        				INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
        				INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
        				LD_RUNPATH_SEARCH_PATHS = (
        					"$(inherited)",
        					"@executable_path/Frameworks",
        				);
        				MARKETING_VERSION = 1.0;
        				PRODUCT_BUNDLE_IDENTIFIER = com.officialzpb.aria;
        				PRODUCT_NAME = "$(TARGET_NAME)";
        				SWIFT_EMIT_LOC_STRINGS = YES;
        				SWIFT_VERSION = 5.0;
        				TARGETED_DEVICE_FAMILY = "1,2";
        			};
        			name = Debug;
        	};
        		A1B2C3D4E5F6789012345682 /* Release */ = {
        			isa = XCBuildConfiguration;
        			buildSettings = {
        				ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
        				CODE_SIGN_STYLE = Automatic;
        				CURRENT_PROJECT_VERSION = 1;
        				GENERATE_INFOPLIST_FILE = YES;
        				INFOPLIST_KEY_NSMicrophoneUsageDescription = "ARIA needs microphone access for voice commands";
        				INFOPLIST_KEY_NSSpeechRecognitionUsageDescription = "ARIA needs speech recognition to process your voice";
        				INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES;
        				INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES;
        				INFOPLIST_KEY_UILaunchScreen_Generation = YES;
        				INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
        				INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
        				LD_RUNPATH_SEARCH_PATHS = (
        					"$(inherited)",
        					"@executable_path/Frameworks",
        				);
        				MARKETING_VERSION = 1.0;
        				PRODUCT_BUNDLE_IDENTIFIER = com.officialzpb.aria;
        				PRODUCT_NAME = "$(TARGET_NAME)";
        				SWIFT_EMIT_LOC_STRINGS = YES;
        				SWIFT_VERSION = 5.0;
        				TARGETED_DEVICE_FAMILY = "1,2";
        			};
        			name = Release;
        	};
        /* End XCBuildConfiguration section */

        /* Begin XCConfigurationList section */
        		A1B2C3D4E5F6789012345652 /* Build configuration list for PBXProject "ARIA" */ = {
        			isa = XCConfigurationList;
        			buildConfigurations = (
        				A1B2C3D4E5F6789012345672 /* Debug */,
        				A1B2C3D4E5F6789012345673 /* Release */,
        			);
        			defaultConfigurationIsVisible = 0;
        			defaultConfigurationName = Release;
        		};
        		A1B2C3D4E5F6789012345680 /* Build configuration list for PBXNativeTarget "ARIA" */ = {
        			isa = XCConfigurationList;
        			buildConfigurations = (
        				A1B2C3D4E5F6789012345681 /* Debug */,
        				A1B2C3D4E5F6789012345682 /* Release */,
        			);
        			defaultConfigurationIsVisible = 0;
        			defaultConfigurationName = Release;
        		};
        /* End XCConfigurationList section */
        	};
        	rootObject = A1B2C3D4E5F6789012345651 /* Project object */;
        }
        PROJEOF
        
    - name: Build iOS App
      run: |
        cd ARIA-iOS
        
        # Build the app
        xcodebuild -project ARIA.xcodeproj \
          -scheme ARIA \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath "$PWD/build/ARIA.xcarchive" \
          archive \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          | tee build.log
          
    - name: Create IPA
      run: |
        cd ARIA-iOS
        
        # Check if archive exists
        if [ -d "build/ARIA.xcarchive/Products/Applications/ARIA.app" ]; then
          echo "Archive found, creating IPA..."
          mkdir -p Payload
          cp -r build/ARIA.xcarchive/Products/Applications/ARIA.app Payload/
          zip -r ARIA.ipa Payload
          echo "IPA created:"
          ls -lh ARIA.ipa
        else
          echo "Build failed - archive not found"
          echo "Build log:"
          cat build.log | tail -100
          exit 1
        fi
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ARIA-iOS-IPA
        path: ARIA-iOS/ARIA.ipa
        retention-days: 30
        
    - name: Upload Build Logs on Failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: ARIA-iOS/build.log
        retention-days: 7
